var three = require("three");
var cannon = require("cannon");
var geomLib = require("geometry/lib");
var BaseGun = require("./BaseGun");

function HitScanExploder(pos) {
	var geometry = geomLib.gunBase(0.035, 0.065, 1.5, 16, 1);
	BaseGun.call(this, pos, geometry);
	this.primaryFireStart = primaryFireStart.bind(this);
}

HitScanExploder.prototype = Object.create(BaseGun.prototype);

var relative = new three.Vector3();
var result = new cannon.RaycastResult();
function primaryFireStart(pos, playerSize) {
	var from = new three.Vector3();
	var to = new three.Vector3();
	relative.subVectors(this.player.user.crosshair.localToWorld(to), this.player.camera.localToWorld(from));
	relative.multiplyScalar(100);
	to.add(relative);

	this.player.world.physics.raycastClosest(from, to, {
		skipBackfaces: true
	}, result);
	if(result.hasHit) {
		this.player.world.makeHitEffect(result.hitPointWorld, playerSize);
		if(result.body.type == cannon.Body.DYNAMIC) {
			result.body.applyImpulse(relative, result.hitPointWorld);
		}
	}
}

module.exports = HitScanExploder;